{% extends 'core/base.html' %}
{% load static %}

{% block stylesheets %}
    <link rel="stylesheet" href="{% static 'core/css/dashboard.css' %}">
{% endblock %}

{% block title %}
    Is It Full? - Dashboard
{% endblock %}

{% block body %}
    <header>
        <nav class="nav-bar">
            <button class="logo nav-btn" data-section="home-section">
                <img src="{% static 'core/images/favicon/favicon.svg' %}" alt="Is It Full Logo">
            </button>

            <button class="menu-toggle" id="menuToggle" aria-label="Toggle navigation menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </nav>

        <div class="menu" id="Menu">
            <p>Change Password</p>
            <form method="POST" action="">
                {% csrf_token %}
                <button type="submit" name="action" value="signout" class="signout-btn">
                    Sign Out
                </button>
            </form>
            <p>Delete Account</p>
        </div>
    </header>

    <main>
        <div class="dashboard-container">
            <!-- Welcome Section -->
            <section class="welcome-section">
                <h1>Welcome back, {{ user.email|default:"User" }}!</h1>

                {% if user_university %}
                    <div class="university-info">
                        <h2>{{ user_university.name }}</h2>
                        <p class="email-domain">Email domain: {{ user_university.email_domain }}</p>
                    </div>
                {% else %}
                    <div class="no-university-warning">
                        <h2>‚ö†Ô∏è No University Associated</h2>
                        <p>Your account is not associated with any university. Please contact support.</p>
                    </div>
                {% endif %}
            </section>

            <!-- Quick Actions -->
            <section class="quick-actions">
                <h2>Quick Actions</h2>
                <div class="action-buttons">
                    <button class="action-btn report-status" onclick="showReportModal()">
                        üìù Report Space Status
                    </button>
                    <button class="action-btn add-space" onclick="showAddSpaceModal()">
                        ‚ûï Add New Space
                    </button>
                    <button class="action-btn refresh" onclick="location.reload()">
                        üîÑ Refresh Data
                    </button>
                </div>
            </section>

            <!-- Spaces Overview -->
            <section class="spaces-overview">
                <div class="section-header">
                    <h2>Study Spaces at {{ user_university.name|default:"Your University" }}</h2>
                    <div class="filter-options">
                        <select id="spaceTypeFilter" onchange="filterSpaces()">
                            <option value="all">All Types</option>
                            <option value="studying">üìö Studying</option>
                            <option value="eating">üçΩÔ∏è Eating</option>
                            <option value="coffee">‚òï Coffee</option>
                        </select>
                        <select id="occupancyFilter" onchange="filterSpaces()">
                            <option value="all">All Occupancy</option>
                            <option value="free">üü¢ Free</option>
                            <option value="busy">üü° Busy</option>
                            <option value="full">üî¥ Full</option>
                        </select>
                    </div>
                </div>

                {% if university_spaces %}
                    <div class="spaces-grid" id="spacesGrid">
                        {% for space in university_spaces %}
                            <div class="space-card" data-type="{{ space.space_type }}" data-occupancy="{{ space.get_occupancy|default:'unknown' }}">
                                <div class="space-header">
                                    <h3>{{ space.name }}</h3>
                                    <span class="space-type-badge {{ space.space_type }}">
                                        {% if space.space_type == 'studying' %}
                                            üìö Studying
                                        {% elif space.space_type == 'eating' %}
                                            üçΩÔ∏è Eating
                                        {% elif space.space_type == 'coffee' %}
                                            ‚òï Coffee
                                        {% endif %}
                                    </span>
                                </div>

                                <div class="space-details">
                                    <p class="location">üìç {{ space.location }}</p>

                                    <!-- Occupancy Indicator -->
                                    <div class="occupancy-indicator">
                                        {% with occupancy=space.get_occupancy %}
                                            {% if occupancy == 1 %}
                                                <span class="occupancy-status free">üü¢ Free</span>
                                            {% elif occupancy == 2 %}
                                                <span class="occupancy-status free">üü¢ Mostly Free</span>
                                            {% elif occupancy == 3 %}
                                                <span class="occupancy-status busy">üü° Moderate</span>
                                            {% elif occupancy == 4 %}
                                                <span class="occupancy-status busy">üü° Busy</span>
                                            {% elif occupancy == 5 %}
                                                <span class="occupancy-status full">üî¥ Full</span>
                                            {% else %}
                                                <span class="occupancy-status unknown">‚ö™ No Data</span>
                                            {% endif %}
                                            <span class="occupancy-value">
                                                {% if occupancy %}
                                                    {{ occupancy|floatformat:1 }}/5
                                                {% else %}
                                                    N/A
                                                {% endif %}
                                            </span>
                                        {% endwith %}
                                    </div>

                                    <!-- Last Updated -->
                                    {% if space.last_updated %}
                                        <p class="last-updated">
                                            Updated: {{ space.last_updated|timesince }} ago
                                        </p>
                                    {% else %}
                                        <p class="last-updated">Never updated</p>
                                    {% endif %}

                                    <!-- Type-specific Details -->
                                    <div class="type-details">
                                        {% if space.space_type == 'studying' %}
                                            <div class="amenities">
                                                {% if space.has_wifi %}
                                                    <span class="amenity wifi">üì∂ WiFi</span>
                                                {% endif %}
                                                {% if space.has_plugs %}
                                                    <span class="amenity plugs">üîå Plugs</span>
                                                {% endif %}
                                            </div>
                                        {% elif space.space_type == 'eating' %}
                                            <div class="price-range">
                                                Price: {{ space.get_eating_price_range_display }}
                                            </div>
                                            {% if space.student_discounts %}
                                                <span class="discount-badge">üéì Student Discount</span>
                                            {% endif %}
                                        {% elif space.space_type == 'coffee' %}
                                            <div class="coffee-info">
                                                <div class="coffee-quality">
                                                    Quality:
                                                    {% for i in "12345" %}
                                                        {% if forloop.counter <= space.coffee_quality %}
                                                            ‚òÖ
                                                        {% else %}
                                                            ‚òÜ
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                                <div class="coffee-price">
                                                    Price: {{ space.get_coffee_price_range_display }}
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="space-actions">
                                    <button class="btn-report" onclick="reportSpaceStatus('{{ space.id }}')">
                                        Report Status
                                    </button>
                                    {% if space.is_composite %}
                                        <button class="btn-view-children" onclick="viewChildSpaces('{{ space.id }}')">
                                            View Sections
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    {% if not university_spaces %}
                        <div class="no-spaces-message">
                            <p>No spaces have been added to {{ user_university.name }} yet.</p>
                            <button class="btn-add-first-space" onclick="showAddSpaceModal()">
                                ‚ûï Add the First Space
                            </button>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="no-spaces-message">
                        <p>No spaces available for {{ user_university.name|default:"your associated_university" }}.</p>
                        <p>Be the first to add a study space!</p>
                        <button class="btn-add-first-space" onclick="showAddSpaceModal()">
                            ‚ûï Add New Space
                        </button>
                    </div>
                {% endif %}
            </section>

            <!-- Statistics Section -->
            <section class="statistics-section">
                <h2>Quick Stats</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Spaces</h3>
                        <p class="stat-value">{{ university_spaces|length|default:"0" }}</p>
                    </div>
                    <div class="stat-card">
                        <h3>Studying Spaces</h3>
                        <p class="stat-value">
                            {{ university_spaces|length|default:"0" }}
                        </p>
                    </div>
                    <div class="stat-card">
                        <h3>Recently Updated</h3>
                        <p class="stat-value">
                            {% with recent_spaces=university_spaces|slice:":5" %}
                                {{ recent_spaces|length }}
                            {% endwith %}
                        </p>
                    </div>
                    <div class="stat-card">
                        <h3>Your Reports</h3>
                        <p class="stat-value">0</p>
                    </div>
                </div>
            </section>
        </div>

        <!-- Report Status Modal (Hidden by default) -->
        <div id="reportModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close-modal" onclick="closeReportModal()">&times;</span>
                <h2>Report Space Status</h2>
                <form id="reportForm">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="spaceSelect">Select Space:</label>
                        <select id="spaceSelect" required>
                            <option value="">Choose a space...</option>
                            {% for space in university_spaces %}
                                <option value="{{ space.id }}">{{ space.name }} - {{ space.location }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="occupancyLevel">How busy is it?</label>
                        <div class="occupancy-slider">
                            <input type="range" id="occupancyLevel" min="1" max="5" value="3">
                            <div class="slider-labels">
                                <span>üü¢ Free</span>
                                <span>üü° Moderate</span>
                                <span>üî¥ Full</span>
                            </div>
                            <div class="current-value">
                                Current: <span id="occupancyValue">3/5</span>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn-submit-report">Submit Report</button>
                </form>
            </div>
        </div>
    </main>

    <script>
        // Toggle mobile menu
        const menuToggle = document.getElementById('menuToggle');
        const menu = document.getElementById('Menu');

        if (menuToggle && menu) {
            menuToggle.addEventListener('click', () => {
                menu.classList.toggle('active');
            });
        }

        // Modal functions
        function showReportModal() {
            document.getElementById('reportModal').style.display = 'block';
        }

        function closeReportModal() {
            document.getElementById('reportModal').style.display = 'none';
        }

        function showAddSpaceModal() {
            alert('Add Space feature coming soon!');
            // You can implement this later
        }

        // Occupancy slider update
        const occupancySlider = document.getElementById('occupancyLevel');
        const occupancyValue = document.getElementById('occupancyValue');

        if (occupancySlider && occupancyValue) {
            occupancySlider.addEventListener('input', function() {
                occupancyValue.textContent = this.value + '/5';
            });
        }

        // Space filtering
        function filterSpaces() {
            const typeFilter = document.getElementById('spaceTypeFilter').value;
            const occupancyFilter = document.getElementById('occupancyFilter').value;
            const spaceCards = document.querySelectorAll('.space-card');

            spaceCards.forEach(card => {
                const spaceType = card.getAttribute('data-type');
                const occupancy = card.getAttribute('data-occupancy');

                let typeMatch = typeFilter === 'all' || spaceType === typeFilter;
                let occupancyMatch = occupancyFilter === 'all' ||
                    (occupancyFilter === 'free' && (occupancy === '1' || occupancy === '2')) ||
                    (occupancyFilter === 'busy' && (occupancy === '3' || occupancy === '4')) ||
                    (occupancyFilter === 'full' && occupancy === '5');

                if (typeMatch && occupancyMatch) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Report space status
        function reportSpaceStatus(spaceId) {
            document.getElementById('spaceSelect').value = spaceId;
            showReportModal();
        }

        // View child spaces (for composite spaces)
        function viewChildSpaces(parentId) {
            alert(`Viewing child spaces for space ID: ${parentId}. This feature is coming soon!`);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('reportModal');
            if (event.target === modal) {
                closeReportModal();
            }
        }
    </script>

    <style>
        /* Dashboard Styles */
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .welcome-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .welcome-section h1 {
            margin: 0 0 10px 0;
            font-size: 2.5rem;
        }

        .university-info h2 {
            margin: 20px 0 5px 0;
            font-size: 1.8rem;
        }

        .email-domain {
            opacity: 0.9;
            font-size: 1rem;
        }

        .no-university-warning {
            background: #ff6b6b;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .quick-actions {
            margin-bottom: 30px;
        }

        .quick-actions h2 {
            margin-bottom: 15px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .report-status {
            background: #4CAF50;
            color: white;
        }

        .add-space {
            background: #2196F3;
            color: white;
        }

        .refresh {
            background: #FF9800;
            color: white;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .filter-options {
            display: flex;
            gap: 10px;
        }

        .filter-options select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        .spaces-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .space-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .space-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .space-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .space-header h3 {
            margin: 0;
            font-size: 1.3rem;
        }

        .space-type-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
        }

        .space-type-badge.studying {
            background: #e3f2fd;
            color: #1976d2;
        }

        .space-type-badge.eating {
            background: #f1f8e9;
            color: #689f38;
        }

        .space-type-badge.coffee {
            background: #fff3e0;
            color: #f57c00;
        }

        .location {
            color: #666;
            margin: 5px 0;
        }

        .occupancy-indicator {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
        }

        .occupancy-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
        }

        .occupancy-status.free { background: #d4edda; color: #155724; }
        .occupancy-status.busy { background: #fff3cd; color: #856404; }
        .occupancy-status.full { background: #f8d7da; color: #721c24; }
        .occupancy-status.unknown { background: #e9ecef; color: #495057; }

        .occupancy-value {
            font-weight: bold;
        }

        .last-updated {
            font-size: 0.9rem;
            color: #888;
            margin: 5px 0;
        }

        .amenities, .type-details {
            margin: 10px 0;
        }

        .amenity {
            display: inline-block;
            padding: 4px 8px;
            margin-right: 5px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .discount-badge {
            background: #ffeb3b;
            color: #333;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .space-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-report, .btn-view-children {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .btn-report {
            background: #4CAF50;
            color: white;
        }

        .btn-view-children {
            background: #2196F3;
            color: white;
        }

        .statistics-section {
            margin-top: 40px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 1rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
            margin: 0;
        }

        .no-spaces-message {
            text-align: center;
            padding: 40px;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 20px 0;
        }

        .btn-add-first-space {
            padding: 12px 24px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 15px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .close-modal {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 28px;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group select, .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        .occupancy-slider {
            margin-top: 10px;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.9rem;
        }

        .current-value {
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
        }

        .btn-submit-report {
            width: 100%;
            padding: 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .spaces-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .filter-options {
                width: 100%;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .space-actions {
                flex-direction: column;
            }
        }
    </style>
{% endblock %}